<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>International trade relationship explorer</title>
<link rel="stylesheet"
	href="https://bootswatch.com/cosmo/bootstrap.min.css">

<script src="https://use.fontawesome.com/1dc8d7edaf.js"></script>
<link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans" />
<link rel="stylesheet" href="//code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css">
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://d3js.org/d3.v4.min.js"></script>
</head>

<style>
#container {
	
	width: 100%;
	height: 50%;
	border: 1px dotted #CCC;
}


.input{

padding:5px;
width: 80%;

}

body {
	font-size:13px;
	color:#333;
}
.table {

	font-size:13px;

}

.btn {

	margin:5px;

}

.ui-widget {

	font-family: 'Open Sans', sans-serif;
	font-size: 13px;

}

.ui-widget input{

	font-family: 'Open Sans', sans-serif;
	font-size: 13px;
	border-radius: none;
	

}

.ui-widget button{

	font-family: 'Open Sans', sans-serif;
	font-size: 13px;

}


.trade-stats-explain {
	padding:10px;
	float:left;
	font-size:10px;
	bottom:0;
	position:absolute;

}

.title{

	font-size:18px;
	font-weight:700;
	padding-top:10px;
	float:left;
}

.legend {
	padding:10px;
	float:right;
	font-size:10px;
}


.controls {

    position: absolute;
    right: 0px;
    top: 30px;
    width: 150px;
    padding: 10px;
    font-size: 10px;


}

div#tooltip {
	position: absolute;
	display: inline-block;
	padding: 2px;
	font-family: 'Open Sans' sans-serif;
	color: #000;
	background-color: #fff;
	border: 1px solid #999;
	border-radius: 2px;
	pointer-events: none;
	opacity: 0;
	z-index: 1;
}
</style>

<script>
function number_format(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
}

</script>

		


<body>
	<div class="container">
		<div class="row">

			<div class="col-sm-12 col-md-12">
				<h2>
					<b>International trade graph explorer</b>
				</h2>

			</div>
		</div>
		<div style="margin-top: 20px; margin-bottom:20px" class="row">
			
			<div class="col-sm-4 col-md-5">
				
				<div class="ui-widget">	
					<div>
					Search for a trader
					</div>
					<input class="input" id="query" name="query">
					<button id="search" class="btn btn-primary btn-sm">Show</button>
					
					<input id="n" name="n" value="2" type="hidden">
					<input id="lim" name="lim" value="100" type="hidden">
					<input id="q" name="q" type="hidden">
	
				</div>
			</div>
			
			
			
			<div class="col-sm-4 col-md-5">
				<div>Example trader 
				</div>
				<select class="input" id="example_company" name="example_company">
					<option selected="selected" value="KOTTKE LTD">KOTTKE LTD</option>
					<option value="ALEXANDER MILLS">ALEXANDER MILLS</option>
					<option value="SIM FREE LTD">SIM FREE LTD</option>
					<option value="BAKER HUGHES LTD">BAKER HUGHES LTD</option>
				</select>
				<button id="go" class="btn btn-primary btn-sm">Display</button>

			</div>


			<div class="col-sm-2 col-md-2">

				<button id="split" class="btn btn-warning btn-sm">Centre</button>
				<button id="reset" class="btn btn-success btn-sm">Refresh</button>

			</div>

		</div>
		
		
	

	<div class="row">

		<div class="col-md-12" id="container">
		<div id="title" class="title"></div>
		<div id="legend" class="legend">

			
			<i style="color: purple" class="fa fa-circle"
				aria-hidden="true"></i> Focus company
				<i style="color: red" class="fa fa-circle"
				aria-hidden="true"></i> Import good
				<i style="color: blue" class="fa fa-circle"
				aria-hidden="true"></i> Export good
				<i style="color: yellow" class="fa fa-circle"
				aria-hidden="true"></i> Importer
				<i style="color: green" class="fa fa-circle"
				aria-hidden="true"></i> Exporter
			
			</div>
			
			<div id="controls" class="controls">

				<div>
				
					Goods in common <select id="num_nodes" name="num_nodes">
						<option value="1">1</option>
						<option selected="selected" value="2">2</option>
						<option value="3">3</option>
					</select>
					
				</div>
				
				<div>
				
					Nodes limit <select id="node_limit"
						name="node_limit">
						<option value="10">10</option>
						<option selected="selected" value="100">100</option>
						<option value="1000">1,000</option>
						<option value="10000">10,000</option>
					</select>
				</div>	
				
			
				<div>
					<input type="range" min="0" max="50" value="10" class="slider"
						id="labelrange">
					<span style="float:left">No labels</span>	
					<span style="float:right">More</span>
				</div>
				
			</div>	
			
			
		<div class="trade-stats-explain">Explore goods by clicking on a blue import good <i style="color: blue" class="fa fa-circle" aria-hidden="true"></i> or
				red import good node <i style="color: red" class="fa fa-circle" aria-hidden="true"></i> to reveal export trading below.
		</div>	
		</div>

		<div id="tooltip">hello</div>
		
		


		
		

		</div>
	

<div id="trade-stats-placeholder"></div>

<div id="trade-stats" style="display:none">
	<div class="row">

		<div class="col-md-12">
			
			<h3><b>Trade statistics</b></h3>
		
			<p>Sales within the <span id="cn_code"></span> commodity code (<span id="ProdName"></span>) from the UK to all destinations across the world from Jul 2016 to Apr 2017 accounted for 
			&pound;<span id="SumV"></span>,
			which were carried out in 
			<span id="SumC"> </span> shipments.</p>

			<p>Trades that were worth less than &pound;1 million accounted for 
			&pound;<span id="PercentVSmall"> </span> million of this total, carried out in 
			<span id="SumCSmalls"></span> shipments.
			</p>
		</div>
	</div>


		<div class="row">
		
		<div class="col-md-6 col-sm-6">
				
			<table class="table table-striped table-condensed">
	         
	         <tr><td colspan=2><b>Details</b></td></tr>
			
			<tr><td>Value of large exports (&gt; 1m)</td><td><span id="SumVLarges"></span></td></tr>
			<tr><td>Value of smaller exports (&lt; 320k)</td><td><span id="SumVSmalls"></span></td></tr>
			<tr><td>No of large exports</td><td><span id="SumCLarges"></span></td></tr>
			<tr><td>No of small exports</td><td><span id="SumCSmalls"></span></td></tr>
		

			<tr><td colspan=2><b>Shipping details</b></td></tr>
			<tr><td>Number by sea</td><td><span id="SumSea"></span></td></tr>
			<tr><td>Number by London Heathrow</td><td><span id="SumAirLHR"></span></td></tr>
			<tr><td>Number by other airports</td><td><span id="SumOtherAir"></span></td></tr>
			
			<tr><td colspan=2><b>Customs</b></td></tr>
			<tr><td>For re-export &lt; &pound;1m</td><td><span id="SumReexCSub1m"></span></td></tr>
			<tr><td>For re-export &gt; &pound;1m</td><td><span id="SumReexLarger"></span></td></tr>
			<tr><td>Inward/outward process relief &gt; &pound;1m</td><td><span id="SumCIPROPRLarger"></span></td></tr>
			<tr><td>Not using </td><td><span id="SumCIPROPRsub1m"></span></td></tr>
			
			

	                    
	                    
	          
	       
	            </table>
				
			</div>
			<div class="col-sm-6 col-md-6">
				<table id="top_countries" class="table table-striped table-condensed">
	                <thead>
	                <tr>
	                    <td><b>Country</b></td>
	                    <td><b>Value (&pound;m)</b></td>
	                </tr>
	                </thead>
	                
	                <tbody></tbody>
	                
	            </table>
		
			</div>
		</div>

	</div>
</div>

</div>

	<script>

	
var width = $('#container').width(), height=$('#container').height();
var canvas = d3.select('#container').append('canvas').attr('width', width).attr('height', height);

$(function() {
	
	$("#query").autocomplete({
		source : function(request, response) {
			$.ajax({
				url : "/companies",
				type : "GET",
				crossDomain : true,
				
				contentType : "application/json",
				dataType : 'json',
				data : {
					q : request.term
				},
				
				success : function(data) {

					response($.map(data.names, function(item, idx) {
						return {
							label : item.name
							//regnum: item.company_number
							
						};
					}));
					
					
				
				}
			});
		},
		minLength : 2,
		select : function(event, ui) {
			
	//		$("#regnum").val(ui.item.regnum);
		//	$("#company_name").val(ui.item.label);
			$("#q").val( encodeURIComponent(ui.item.names));
			
		},
		open : function() {
			$(this).removeClass("ui-corner-all").addClass("ui-corner-top");
		},
		close : function() {
			$(this).removeClass("ui-corner-top").addClass("ui-corner-all");
		}
	});
});


$("#search").click( function() {
	 
	var query=$("#query").val();
	var query2=$("#n").val();
	var query3=$("#lim").val();
		  
		d3.json("/graph?q=" + encodeURIComponent(query) + 
				"&n=" + encodeURIComponent(query2) +
				"&lim=" + encodeURIComponent(query3) , function(error, json) {
		  if (error) throw error;
		       		  
		  	graph = json;
		  
			nodes = graph.nodes;
	   		links = graph.links;
		
	   		   		
	   		draw();
		});
		
		$('#title').text(query);
		
	    }
);	

$("#go").click( function() {
		 
	var query=$("#example_company").val();
		  var query2=$("#num_nodes").val();
		  var query3=$("#node_limit").val();
		  
		d3.json("/graph?q=" + encodeURIComponent(query) + 
				"&n=" + encodeURIComponent(query2) +
				"&lim=" + encodeURIComponent(query3) , function(error, json) {
		  if (error) throw error;
		       		  
		  	graph = json;
		  
			nodes = graph.nodes;
	   		links = graph.links;
		
	   		   		
	   		draw();
		});
		
		$('#title').text(query);
		
	    }
);	


var fixed_layout;
  
d3.select('button#split').on('mousedown', function(d) {

	fixed_layout = true;
	
	simulation.stop();
	
	simulation
		.force('charge', d3.forceManyBody().strength(
				function(d) { 
				
					return d.type === "company" ? -250 : 0; 
					
				} 		
		
		))
		 .force("link", d3.forceLink(links).distance(100).strength(5))
		.force('xPos', d3.forceX(function(d) { 
			
			return d.direction === "Imported" ? width * -0.5 : width * 0.5; 
			
		}) )
		.force('yPos', d3.forceY(function(d) { 
			
			return d.type === "hscode" ? 0 : height * -0.8; 
			
		}));
		
	simulation.alpha(0.5);

	
	
	simulation.restart();

}); // button listener/handler

d3.select('button#reset').on('mousedown', function(d) {

	draw();
	
	/* simulation.stop();

	nodes = [];
	links = [];
	force.nodes(nodes);
	force.links(links);
	
	simulation
	 .force("charge", d3.forceManyBody().strength(-30))
	    .force("link", d3.forceLink(links).distance(40).strength(1))
	    .force("x", d3.forceX())
	    .force("y", d3.forceY());
		
	simulation.alpha(0.5);

	simulation.restart(); */

}); // button listener/handler




 // Toggle children on click.
    function click() {
	 
    
	const a = this.parentNode;
    const m = d3.mouse(this);
       
    
    console.log("x=" + m[0] +"y=" + m[1]);
    
    console.log("x=" + trans.invertX(m[0]) +"y=" + trans.invertY(m[1]));

    
    	    const d = simulation.find(
    	      trans.invertX(m[0] - width / 2),
    	      trans.invertY(m[1] - height / 2),
    	      10);
    
    	 
    	
     console.dir(d);
	 
     if (d.type=="company") {
     
        context.clearRect(0, 0, canvas.width, canvas.height);
         
        var query = d.name;
        var query2=$("#num_nodes").val();
        var query3=$("#node_limit").val();	
		
        $("#title").text(d.name);
        
        
        d3.json("/graph?q=" + encodeURIComponent(query) + 
				"&n=" + encodeURIComponent(query2) +
				"&lim=" + encodeURIComponent(query3) , function(error, json) {
		  if (error) throw error;
   			
   		
   			
   			if (error) throw error;
   			  graph = json;
   			  
   			  nodes = graph.nodes;
   			  links = graph.links;
   			  
   			  draw();
   		
   		});
     }
     
     else if (d.type =="hscode" && d.direction == "Exported") { 
    	 
    	 var searchstring = "/descriptions?cn1=" + d.name;
    	 
    	 $.get(searchstring, function(data, status){$("#goods_descriptions").text(data.description)});
    	 
    	 $("#cn_code").text(d.name);
    	 
    	 var searchstring2 = "/HS_tool?cn1=" + d.name;
		
    
       	 $.get(searchstring2, function(data, status, xhr){

     	 	if (!data || data.length == 0) return;
     	 	
     	 	var t1 = $("table#export_summary tbody").empty();
     	 	var t2 = $("table#top_countries tbody").empty();
     	 	

     	 	$("#ProdName").text(data.ProdName);    	 	
     	 	
     	 	$("#SumAirLHR").text(number_format(data.SumAirLHR));
     	 	$("#SumCIPROPRLarger").text(number_format(data.SumCIPROPRLarger));
     	 	$("#SumCIPROPRsub1m").text(number_format(data.SumCIPROPRsub1m));
     	 	$("#SumCLarges").text(number_format(data.SumCLarges));
     	 	$("#SumCSmalls").text( number_format(data.SumCSmalls));
     	 	$("#SumOtherAir").text(number_format(data.SumOtherAir));
     	 	$("#SumReexCSub1m").text(number_format(data.SumReexCSub1m));
     	 	$("#SumReexLarger").text(number_format(data.SumReexLarger));
     	 	$("#SumSea").text(number_format(data.SumSea));
     	 	$("#SumVLarges").text(number_format(data.SumVLarges));
     	 	$("#SumVSmalls").text(number_format(data.SumVSmalls));
     	 	
     	 	var SumV = number_format(Math.round((data.SumVSmalls + data.SumVLarges)/1000000000, 2)); 
     	 	if (SumV>2000000000) {
     	 		$("#SumV").text(SumV+' billion');
     	 	} else {
     	 		$("#SumV").text(number_format(Math.round((data.SumVSmalls + data.SumVLarges)/1000000, 2))+' million');
     	 	}
     	 	   
    	 	var SumC = number_format(data.SumCSmalls + data.SumCLarges);
    	 	$("#SumC").text(SumC);
    	 	
    	 	var PercentVSmall = number_format( Math.round(data.SumVSmalls/1000000));
    	 	$("#PercentVSmall").text(PercentVSmall);
     	 	     	 	
     	 	for (n in data) {
     	 		if (n == 'ProdName') {
     	 			$("#goods_section").text(data[n])
     	 		} else if (n == 'top_countries_list') {
     	 			// console.log('got here')
     	 			for (p in data[n]) {
     	 				$("<tr><td>" + data[n][p]['Country'] + "</td><td>" + 
     	 						number_format(data[n][p]['Value']) + "</td></tr>").appendTo(t2)
     	 			}
     	 		} else {
     	 			$("<tr><td>" + n + "</td><td>" + data[n] + "</td></tr>").appendTo(t1)
     	 		// parseInt(data[n]).toLocaleString('en-UK', {maximumSignificantDigits: 6})
     	 		}
     	 	};

     	 }, "json");
       	 
     	$("#trade-stats-placeholder").hide();
     	$("#trade-stats").fadeIn();
     	
     	return false;
    
     
     	
     }
 
     
	}
    

    

var nodes, 
	links,
	context,
	canvas, 
	simulation,
	label_detail;
	

label_detail = 10;
		
var trans = d3.zoomIdentity; //<-- identity

var brush;
var temp_pan_x, temp_pan_y;


function draw() {

	 simulation = d3.forceSimulation(nodes)
	 
	// .alpha(0.5)
	    .force("charge", d3.forceManyBody().strength(-40))
	    .force("link", d3.forceLink(links).distance(20).strength(2))
	    .force("x", d3.forceX())
	    .force("y", d3.forceY())
	    .on("tick", ticked);

	// var center_force = d3.forceCenter(width / 2, height / 2);  

	
	 canvas = document.querySelector("canvas"),
	    context = canvas.getContext("2d"),
	//    width = canvas.width,
	//    height = canvas.height;
	  
	
	
	d3.select(canvas)
	    .call(d3.drag()
	        .container(canvas)
	        .subject(dragsubject)
	        .on("start", dragstarted)
	        .on("drag", dragged)
	        .on("end", dragended));
	 
	
	
	d3.select(canvas).on("mousemove",tooltip);
	
//	  brush.call(d3.brush()
	//	        .extent([[0, 0], [width, height]])
		 //       .on("start", brushstarted)
	//	        .on("brush", brushed)
		//        .on("end", brushended));
	
	
    function zoomed(d) {
		  trans = d3.event.transform; //<-- set to current transform
		
			console.log("x=" + trans.x + " y=" + trans.y + " k=" +trans.k);		  

		  
		  //context.translate()
		  ticked(); //<-- use tick to redraw regardless of event
		}
	    
	  //now the zooming part
	   d3.select(canvas)
	   		.call(d3.zoom()
	   				.scaleExtent([0.2, 10])
	   			
	   				.on("zoom", zoomed));

		
	d3.select(canvas).on('click', click);
	    
	d3.select('#labelrange').on('input', function() {
		
		label_detail = $('#labelrange').val();
		ticked();
	});
	 
	


	
	function ticked() {
					
		context.save();
		
	 	context.clearRect(0, 0, width, height);
	  	
	  	//context.translate(width / 2, height / 2);
	  	
	  	context.translate(trans.x + width/2, trans.y + height/2); //<-- this always applies a transform
	
			  	
	  	context.scale(trans.k, trans.k);
	
	 	context.beginPath();
	  	links.forEach(drawLink);
  		context.strokeStyle = "#CCC";
  		context.lineWidth=0.5;
	 	context.stroke();
	
	 
	  	nodes.forEach(drawNode);
	  	
	 	if (fixed_layout) {
				
				nodes[0].x = 0;
				nodes[0].y = 0;
		
		}
	  
  		
	  	context.restore();
	  	
	}
	
}




var start_x, start_y

function dragsubject() {
  return simulation.find(trans.invertX(d3.event.x - width/2), trans.invertY(d3.event.y-height/2), 10);
}

function dragstarted() {
  if (!d3.event.active) simulation.alphaTarget(0.3).restart();
  
  start_x = d3.event.subject.x;
  start_y = d3.event.subject.y;
  
  d3.event.subject.fx = d3.event.subject.x;
  d3.event.subject.fy = d3.event.subject.y;
  console.log("start x = " + d3.event.subject.x)
  console.log("start y = " + d3.event.subject.y)
}

function dragged() {
	
  d3.event.subject.fx = start_x + (d3.event.x - start_x)/trans.k;
  d3.event.subject.fy = start_y + (d3.event.y - start_y)/trans.k;
  //console.log("start x = " + trans.k)

  
}

function dragended() {
  if (!d3.event.active) simulation.alphaTarget(0);
  //d3.event.subject.fx = null;  Commenting out makes sticky
  //d3.event.subject.fy = null;

}

function drawLink(d) {
  context.moveTo(d.source.x, d.source.y);
  context.lineTo(d.target.x, d.target.y);
}




function tooltip() {

	const a = this.parentNode;
    const m = d3.mouse(this);
       
    
    //console.log("x=" + m[0] +"y=" + m[1]);
    //
   // console.log("x=" + trans.invertX(m[0]) +"y=" + trans.invertY(m[1]));

    
    const d = simulation.find(
    	      trans.invertX(m[0] - width / 2),
    	      trans.invertY(m[1] - height / 2),
    	      10);
	
	
if (d) {

	// Show the tooltip only when there is nodeData found by the mouse

	var tooltip_html;

	if (d.type =="hscode") {
		
	var searchstring = "/descriptions?cn1=" + d.name;	
		
 // 	$.get(searchstring, function(data, status){
 // 		tooltip_html = data;
 // 	});
 
	 $.ajax({
         async: false,
         type: "GET",
         url: searchstring,
         //data: '{name: "Mudassar" }',
         //contentType: "application/json; charset=utf-8",
         dataType: "json",
         success: function (data) {
        	 tooltip_html = data.description;
         }
     });
 

	}
	else {
		
		tooltip_html = d.name;
		
	}
 
  	
	d3.select('#tooltip')
		.style('opacity', 0.8)
		.style('top', d3.event.pageY + 5 + 'px')
		.style('left', d3.event.pageX + 5 + 'px')
		.html(tooltip_html);
	
	
	

} else {

	// Hide the tooltip when there our mouse doesn't find nodeData

	d3.select('#tooltip')
		.style('opacity', 0);

} 

}




function drawNode(d) {
	
	var r = Math.pow(d.size,0.25);
	
	var pos_str = Math.round(d.x) + "," + Math.round(d.y);
	context.font="7px Arial";
	// Companies circles
 		
	if (d.type == "company")	{
		context.beginPath();	
	  	context.moveTo(d.x+2*r, d.y);
	  	context.arc(d.x, d.y, 2* r, 0, 2 * Math.PI);
		
		if (d.direction == "Imported") context.fillStyle = "yellow";
		else if (d.direction == "Exported") context.fillStyle = "green";
		else {
			context.fillText(pos_str,d.x+1.1*r,d.y-1.1*r);
			context.fillStyle = "purple";
		}
		
		context.fill();
		
		context.fillStyle = "#333";
		
	
		
		
		// TODO: rank number filter
		
		
		if (d.rank < label_detail) { 
		
		context.fillText(d.name,d.x+1.1*r,d.y-1.1*r);

		}
		
	}		
		
	if (d.type == "hscode")	{
		
		
		
		context.beginPath();	
	  	context.moveTo(d.x+r/2, d.y);
	  	context.arc(d.x, d.y, r/2 , 0, 2 * Math.PI);
	  	
		if (d.direction == "Imported") context.fillStyle = "red";
		else if (d.direction == "Exported") context.fillStyle = "blue";

		context.fill();
	}
			
	context.strokeStyle = "#CCC";
  	context.stroke();
  	

  	
}

</script>


</body>
</html>